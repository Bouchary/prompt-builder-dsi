<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Prompt Builder — DSI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    borderRadius: {
                        'card': '1rem',
                        'btn': '1rem',
                    },
                }
            },
            plugins: [],
        }
    </script>
    <style type="text/tailwindcss">
        @layer components {
            .card { @apply bg-white rounded-card shadow-md p-4; }
            .btn { @apply rounded-btn px-4 py-2 bg-indigo-600 text-white font-medium hover:bg-indigo-700 transition-colors; }
            .btn-ghost { @apply rounded-btn px-4 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors; }
            .chip { @apply inline-flex items-center gap-1 border border-gray-200 rounded-full px-3 py-1 bg-gray-50 text-sm; }
            .form-input { @apply w-full rounded-btn border px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500; }
            .modal-overlay { @apply fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50; }
            .modal-content { @apply bg-white rounded-lg p-6 max-w-sm w-full shadow-lg; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 transition-colors duration-300">

    <div class="min-h-screen w-full py-8">
        <div class="mx-auto max-w-6xl px-4">
            <div class="flex items-center mb-6 gap-4">
                <div class="relative w-16 h-16" id="logo-container">
                    <img id="logo-preview" class="w-full h-full object-contain" src="" alt="Logo" />
                    <button id="remove-logo" class="absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full text-xs hidden" title="Supprimer le logo.">✕</button>
                </div>
                <h1 id="main-title" class="text-3xl font-semibold">Assistant de création de prompt</h1>
            </div>
            <div id="main-content" class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="space-y-4">

                    <div class="card">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Domaine (présélection)</label>
                                <select id="domain" class="form-input" title="Choisissez un domaine pour prérégler la tâche et les options."></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Format de sortie</label>
                                <select id="format" class="form-input" title="Définit la structure de la réponse de l'IA (plan, tableau, etc.)."></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Niveau de détail</label>
                                <select id="detail" class="form-input" title="Contrôle la profondeur de la réponse (synthèse, standard, exhaustif)."></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Langue</label>
                                <select id="lang" class="form-input" title="Spécifie la langue de la réponse."></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ton</label>
                                <select id="tone" class="form-input" title="Définit le style d'écriture de l'IA."></select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rôle</label>
                        <select id="role" class="form-input mb-3" title="Assignez un rôle à l'IA pour qu'elle adopte une expertise spécifique."></select>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <div class="md:col-span-2">
                                <input id="newRole" class="form-input" placeholder="Ajouter un rôle personnalisé" title="Entrez un rôle personnalisé, comme 'Architecte d'entreprise' ou 'Manager des opérations IT'.">
                            </div>
                            <button id="addRole" class="btn-ghost" title="Ajouter le rôle personnalisé à la liste déroulante.">+ Ajouter</button>
                        </div>
                        <div id="rolesChips" class="mt-3 flex flex-wrap gap-2"></div>
                    </div>

                    <div class="card">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tâche (objectif principal)</label>
                        <div id="quickTasks" class="flex flex-wrap gap-2 mb-2"></div>
                        <textarea id="task" class="form-input min-h-[100px]" placeholder="Ex: Rédiger une politique de sécurité SI adaptée à une PME" title="Décrivez clairement et précisément la tâche à accomplir par l'IA."></textarea>
                    </div>

                    <div class="card">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Entreprise</label>
                                <textarea id="company" class="form-input min-h-[60px]" placeholder="Ex: PME de 120 personnes, France, secteur de la santé, en forte croissance.&#10;Contient plusieurs filiales avec des SI indépendants."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Secteur</label>
                                <textarea id="sector" class="form-input min-h-[60px]" placeholder="Ex: Services B2B, Industrie manufacturière, Conseil IT spécialisé en cloud."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Audience</label>
                                <textarea id="audience" class="form-input min-h-[60px]" placeholder="Ex: Comité de direction et équipes IT.&#10;À noter : le COMEX est peu familier avec les termes techniques."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Objectifs</label>
                                <textarea id="goals" class="form-input min-h-[60px]" placeholder="Ex: Produire un livrable exploitable dès la première version.&#10;Faciliter la prise de décision."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contraintes</label>
                                <textarea id="constraints" class="form-input min-h-[60px]" placeholder="Ex: Budget limité, conformité RGPD requise, ressources IT réduites.&#10;Pas d'accès à des outils payants."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Échéance</label>
                                <textarea id="deadline" class="form-input min-h-[60px]" placeholder="Ex: 2 semaines.&#10;Doit être présenté au prochain comité de pilotage."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mode équipes (adapter au public)</label>
                            <label class="flex items-center gap-2">
                                <input id="teamMode" type="checkbox" class="h-4 w-4" checked title="Activez pour adapter le prompt au profil de l'équipe sélectionnée.">
                                <span class="text-sm text-gray-700">Activé</span>
                            </label>
                        </div>
                        <div id="teamSection" class="mt-3">
                            <select id="team" class="form-input mb-2" title="Sélectionnez le profil de l'équipe pour adapter le ton et les instructions."></select>
                            <ul id="teamAdds" class="list-disc list-inside text-sm text-gray-600"></ul>
                        </div>
                    </div>

                    <div class="card">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Exemples (few‑shot) — optionnel</label>
                        <textarea id="examples" class="form-input min-h-[100px]" placeholder="Exemple 1:\n— Contexte: PME B2B\n— Sortie: plan en 5 sections\n\nExemple 2:\n— …" title="Fournissez des exemples de prompts et de réponses attendues pour guider l'IA."></textarea>
                    </div>

                </div>

                <div class="space-y-4">

                    <div class="card">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Critères & sections à inclure</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <label class="flex items-center gap-2"><input id="risks" type="checkbox" class="h-4 w-4" checked title="Demande à l'IA d'inclure une section sur les risques potentiels."/> <span>Inclure Risques</span></label>
                            <label class="flex items-center gap-2"><input id="costs" type="checkbox" class="h-4 w-4" checked title="Demande une estimation des coûts ou du coût total de possession (TCO)."/> <span>Inclure Coûts/TCO</span></label>
                            <label class="flex items-center gap-2"><input id="kpi" type="checkbox" class="h-4 w-4" checked title="Demande à l'IA de proposer des indicateurs de performance (KPI)."/> <span>Inclure KPI</span></label>
                            <label class="flex items-center gap-2"><input id="deps" type="checkbox" class="h-4 w-4" checked title="Demande de lister les dépendances et prérequis nécessaires."/> <span>Inclure Dépendances</span></label>
                            <label class="flex items-center gap-2"><input id="limits" type="checkbox" class="h-4 w-4" checked title="Demande d'expliciter les hypothèses et les limites du document."/> <span>Inclure Hypothèses/Limites</span></label>
                            <label class="flex items-center gap-2"><input id="sources" type="checkbox" class="h-4 w-4" title="Demande à l'IA de citer les sources ou références qu'elle a utilisées."/> <span>Demander Sources</span></label>
                            <label class="flex items-center gap-2"><input id="allowUnknown" type="checkbox" class="h-4 w-4" checked title="Indique à l'IA de répondre 'Je ne sais pas' plutôt que d'inventer des informations."/> <span>Autoriser “Je ne sais pas”</span></label>
                            <label class="flex items-center gap-2"><input id="listUnknowns" type="checkbox" class="h-4 w-4" checked title="Demande à l'IA de lister les informations qu'il lui manque pour être plus précis."/> <span>Lister Inconnues/Questions</span></label>
                        </div>
                    </div>

                    <div class="card">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Critères d’acceptation</label>
                        <textarea id="acceptance" class="form-input min-h-[100px]" placeholder="Ex: Couverture complète, cohérence, actionnable, conforme RGPD, pas d’invention." title="Définissez les critères de qualité que le résultat de l'IA doit respecter."></textarea>
                    </div>

                    <div class="card">
                        <div class="flex items-center justify-between mb-2">
                            <h2 class="text-lg font-medium">Aperçu du prompt généré</h2>
                            <span id="copiedBadge" class="text-green-600 text-sm hidden">Copié ✓</span>
                        </div>
                        <pre id="preview" class="whitespace-pre-wrap text-sm bg-gray-50 rounded-xl p-4 border border-gray-200 max-h-[70vh] overflow-auto"></pre>
                    </div>

                    <div class="card">
                        <p class="text-sm text-gray-500">Astuce : collez ce prompt dans votre outil d’IA. Les balises &lt;contexte&gt;, &lt;instructions&gt;, &lt;exemples&gt; et le bloc ```tache facilitent une interprétation fiable. Utilisez l’export JSON pour partager vos presets avec d’autres DSI.</p>
                    </div>

                    <div class="flex flex-wrap gap-2">
                        <button id="copyBtn" class="btn flex items-center gap-2" title="Copie le prompt généré dans le presse-papiers.">Copier le prompt</button>
                        <button id="clearBtn" class="btn-ghost hidden" title="Effacer toutes les entrées et champs de texte.">Effacer les entrées</button>
                        <button id="exportBtn" class="btn-ghost flex items-center gap-2" title="Exporte la configuration actuelle au format JSON.">Exporter config</button>
                        <label class="inline-flex items-center gap-2 cursor-pointer btn-ghost" title="Importe une configuration depuis un fichier JSON.">
                            Importer config <input id="importFile" type="file" accept="application/json" class="hidden" />
                        </label>
                        <button id="settingsBtn" class="btn-ghost flex items-center gap-2" title="Ouvrir les paramètres d'apparence et de personnalisation des menus.">Paramètres</button>
                    </div>
                </div>
            </div>

            <div id="settings-panel" class="hidden mt-6">
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-medium">Gestion des options personnalisées</h2>
                        <button id="closeSettingsBtn" class="text-gray-400 hover:text-gray-700 transition-colors" title="Fermer les paramètres.">✕</button>
                    </div>
                    <div class="space-y-6">
                        <div class="space-y-4">
                            <h3 class="font-medium text-gray-700">Apparence</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Couleur de fond</label>
                                <input type="color" id="bgColor" class="w-16 h-10 p-1 border rounded-lg cursor-pointer" title="Change la couleur de fond de la page.">
                                <span class="text-sm text-gray-500 ml-2">ou</span>
                                <button id="resetBgColor" class="btn-ghost text-sm" title="Réinitialise la couleur de fond à la valeur par défaut.">Réinitialiser</button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Image de fond</label>
                                <div class="flex gap-2 items-center">
                                    <label class="btn-ghost cursor-pointer text-sm" title="Sélectionnez une image pour l'utiliser comme fond d'écran.">
                                        Choisir un fichier
                                        <input type="file" id="bgImageFile" accept="image/*" class="hidden" />
                                    </label>
                                    <button id="removeBgImage" class="btn-ghost text-sm hidden" title="Supprime l'image de fond actuelle.">Supprimer</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Couleur du titre</label>
                                <input type="color" id="titleColor" class="w-16 h-10 p-1 border rounded-lg cursor-pointer" title="Change la couleur du titre principal.">
                                <button id="resetTitleColor" class="btn-ghost text-sm" title="Réinitialise la couleur du titre à la valeur par défaut.">Réinitialiser</button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Logo</label>
                                <div class="flex gap-2 items-center">
                                    <label class="btn-ghost cursor-pointer text-sm" title="Télécharger un logo à afficher à côté du titre.">
                                        Choisir un fichier
                                        <input type="file" id="logoFile" accept="image/*" class="hidden" />
                                    </label>
                                </div>
                            </div>
                        </div>

                        <hr/>

                        <div class="space-y-6">

                            <div>
                                <h3 class="font-medium text-gray-700 mb-2">Domaines personnalisés</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom du domaine</label>
                                        <input id="newDomainName" class="form-input" placeholder="Ex: Plan de migration ERP" title="Nom du domaine à ajouter."/>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Tâches rapides</label>
                                        <textarea id="newDomainTasks" class="form-input min-h-[60px]" placeholder="Ex: Rédiger le cahier des charges&#10;Préparer une présentation au COMEX" title="Entrez une ou plusieurs tâches rapides, séparées par un saut de ligne."></textarea>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Toggles par défaut</label>
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            <label class="flex items-center gap-2"><input id="newDomainRisks" type="checkbox" class="h-4 w-4"/> <span>Risques</span></label>
                                            <label class="flex items-center gap-2"><input id="newDomainCosts" type="checkbox" class="h-4 w-4"/> <span>Coûts</span></label>
                                            <label class="flex items-center gap-2"><input id="newDomainKpi" type="checkbox" class="h-4 w-4"/> <span>KPI</span></label>
                                            <label class="flex items-center gap-2"><input id="newDomainDeps" type="checkbox" class="h-4 w-4"/> <span>Dépendances</span></label>
                                            <label class="flex items-center gap-2"><input id="newDomainLimits" type="checkbox" class="h-4 w-4"/> <span>Hypothèses/Limites</span></label>
                                            <label class="flex items-center gap-2"><input id="newDomainSources" type="checkbox" class="h-4 w-4"/> <span>Sources</span></label>
                                            <label class="flex items-center gap-2"><input id="newDomainAllowUnknown" type="checkbox" class="h-4 w-4"/> <span>Autoriser “Je ne sais pas”</span></label>
                                            <label class="flex items-center gap-2"><input id="newDomainListUnknowns" type="checkbox" class="h-4 w-4"/> <span>Lister Inconnues</span></label>
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <button id="addDomain" class="btn-ghost w-full">+ Ajouter le domaine</button>
                                    </div>
                                </div>
                                <div id="domainChips" class="mt-3 flex flex-wrap gap-2"></div>
                            </div>
                            
                            <hr/>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Formats de sortie</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <div class="md:col-span-2">
                                        <input data-type="format" class="form-input" placeholder="Ajouter un format (ex: 'Compte-rendu')" title="Ajoutez de nouveaux formats de sortie au menu déroulant 'Format de sortie'."/>
                                    </div>
                                    <button data-add="format" class="btn-ghost" title="Ajouter ce format.">+ Ajouter</button>
                                </div>
                                <div id="formatChips" class="mt-3 flex flex-wrap gap-2"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Niveaux de détail</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <div class="md:col-span-2">
                                        <input data-type="detail" class="form-input" placeholder="Ajouter un niveau (ex: 'Très précis')" title="Ajoutez de nouveaux niveaux de détail au menu déroulant 'Niveau de détail'."/>
                                    </div>
                                    <button data-add="detail" class="btn-ghost" title="Ajouter ce niveau de détail.">+ Ajouter</button>
                                </div>
                                <div id="detailChips" class="mt-3 flex flex-wrap gap-2"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tons</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <div class="md:col-span-2">
                                        <input data-type="tone" class="form-input" placeholder="Ajouter un ton (ex: 'Ambitieux')" title="Ajoutez de nouveaux tons d'écriture au menu déroulant 'Ton'."/>
                                    </div>
                                    <button data-add="tone" class="btn-ghost" title="Ajouter ce ton.">+ Ajouter</button>
                                </div>
                                <div id="toneChips" class="mt-3 flex flex-wrap gap-2"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Langues</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <div class="md:col-span-2">
                                        <input data-type="lang" class="form-input" placeholder="Ajouter une langue (ex: 'Espagnol')" title="Ajoutez de nouvelles langues au menu déroulant 'Langue'."/>
                                    </div>
                                    <button data-add="lang" class="btn-ghost" title="Ajouter cette langue.">+ Ajouter</button>
                                </div>
                                <div id="langChips" class="mt-3 flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-semibold mb-4"></h3>
            <p id="modal-text" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-2">
                <button id="modal-cancel" class="btn-ghost">Annuler</button>
                <button id="modal-confirm" class="btn">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // --- Configuration des données ---
            const DATA = {
                outputFormats: [
                    { value: "plan", label: "Plan numéroté" }, { value: "table", label: "Tableau Markdown" },
                    { value: "json", label: "JSON schema" }, { value: "doc", label: "Modèle de document" },
                    { value: "email", label: "Email professionnel" }, { value: "report", label: "Compte‑rendu / Synthèse" },
                ],
                detailLevels: [
                    { value: "synthese", label: "Synthèse" }, { value: "standard", label: "Standard" }, { value: "exhaustif", label: "Exhaustif" },
                ],
                tones: [
                    { value: "pro", label: "Professionnel" }, { value: "pedago", label: "Pédagogique" },
                    { value: "concis", label: "Concis" }, { value: "persuasif", label: "Persuasif" },
                ],
                languages: [
                    { value: "fr", label: "Français" }, { value: "en", label: "English" },
                ],
                defaultRoles: [
                    "Expert cybersécurité PME", "Consultant outillage SI", "Architecte cloud", "Data governance lead",
                    "SRE / Incident manager", "PMO SI", "Juriste IT / RGPD", "CTO coach", "FinOps",
                    "Responsable ITSM / ITAM",
                ],
                teamProfiles: [
                    { value: "comex", label: "COMEX", adds: ["Commencer par un résumé exécutif en 5 puces.", "Limiter le jargon technique et mettre en avant les enjeux business."], tone: "pro", detail: "synthese" },
                    { value: "finance", label: "Direction Finance", adds: ["Mettre en avant TCO, ROI, OPEX/CAPEX, et risques de conformité."], tone: "pro", detail: "standard" },
                    { value: "rh", label: "RH", adds: ["Mettre l’accent sur conduite du changement, formation et impacts humains."], tone: "pedago", detail: "standard" },
                    { value: "ops", label: "Opérations / Production", adds: ["Préciser la continuité de service, RTO/RPO, et procédures opérationnelles."], tone: "pro", detail: "exhaustif" },
                    { value: "it", label: "Équipe IT", adds: ["Inclure détails techniques, prérequis, dépendances et check‑lists."], tone: "pro", detail: "exhaustif" },
                    { value: "juridique", label: "Juridique / RGPD", adds: ["Citer bases légales applicables, responsabilités et preuves de conformité."], tone: "pro", detail: "standard" },
                ],
                domainPresets: {
                    "Cybersécurité": { tasks: ["Rédiger une politique de sécurité SI adaptée à une PME", "Concevoir un plan de sensibilisation sécurité sur 6 mois"], toggles: { risks: true, costs: true, kpi: true, deps: true, limits: true, sources: true } },
                    "ITSM / ITAM": { tasks: ["Comparer 3 solutions ITSM pour une PME (tableau + reco)", "Modéliser un processus de gestion des incidents et SLAs"], toggles: { risks: true, costs: true, kpi: true, deps: true, limits: true, sources: false } },
                    "RGPD / Data Governance": { tasks: ["Produire une politique de rétention et d’archivage (RGPD)", "Construire un registre des traitements priorisé pour une PME"], toggles: { risks: true, costs: false, kpi: true, deps: true, limits: true, sources: true } },
                    "Cloud / FinOps": { tasks: ["Établir un cadre FinOps (gouvernance, budgets, alertes, tagging)", "Comparer 3 options d’hébergement (on‑prem, IaaS, PaaS)"], toggles: { risks: true, costs: true, kpi: true, deps: true, limits: true, sources: false } },
                    "M365 / Collaboration": { tasks: ["Définir une gouvernance M365 (Teams/SharePoint) pour PME", "Rédiger une politique de classification et DLP"], toggles: { risks: true, costs: true, kpi: true, deps: true, limits: true, sources: false } },
                    "Roadmap & KPI": { tasks: ["Proposer une roadmap trimestrielle SI + KPI", "Élaborer un tableau de bord de la disponibilité et sécurité"], toggles: { risks: true, costs: true, kpi: true, deps: true, limits: true, sources: false } }
                }
            };

            // --- Sélecteurs centralisés ---
            const els = {
                domain: document.getElementById("domain"), format: document.getElementById("format"), detail: document.getElementById("detail"),
                lang: document.getElementById("lang"), tone: document.getElementById("tone"), role: document.getElementById("role"),
                newRole: document.getElementById("newRole"), rolesChips: document.getElementById("rolesChips"), addRole: document.getElementById("addRole"),
                task: document.getElementById("task"), quickTasks: document.getElementById("quickTasks"),
                company: document.getElementById("company"), sector: document.getElementById("sector"), audience: document.getElementById("audience"),
                goals: document.getElementById("goals"), constraints: document.getElementById("constraints"), deadline: document.getElementById("deadline"),
                teamMode: document.getElementById("teamMode"), team: document.getElementById("team"), teamAdds: document.getElementById("teamAdds"),
                teamSection: document.getElementById("teamSection"), risks: document.getElementById("risks"), costs: document.getElementById("costs"),
                kpi: document.getElementById("kpi"), deps: document.getElementById("deps"), limits: document.getElementById("limits"),
                sources: document.getElementById("sources"), allowUnknown: document.getElementById("allowUnknown"), listUnknowns: document.getElementById("listUnknowns"),
                examples: document.getElementById("examples"), acceptance: document.getElementById("acceptance"), preview: document.getElementById("preview"),
                copyBtn: document.getElementById("copyBtn"), clearBtn: document.getElementById("clearBtn"), copiedBadge: document.getElementById("copiedBadge"), exportBtn: document.getElementById("exportBtn"),
                importFile: document.getElementById("importFile"), settingsBtn: document.getElementById("settingsBtn"),
                settingsPanel: document.getElementById("settings-panel"), mainContent: document.getElementById("main-content"),
                closeSettingsBtn: document.getElementById("closeSettingsBtn"), bgColor: document.getElementById("bgColor"),
                bgImageFile: document.getElementById("bgImageFile"), removeBgImage: document.getElementById("removeBgImage"),
                resetBgColor: document.getElementById("resetBgColor"), titleColor: document.getElementById("titleColor"),
                resetTitleColor: document.getElementById("resetTitleColor"), mainTitle: document.getElementById("main-title"),
                logoFile: document.getElementById("logoFile"), logoPreview: document.getElementById("logo-preview"),
                logoContainer: document.getElementById("logo-container"), removeLogo: document.getElementById("remove-logo"),
                modalOverlay: document.getElementById("modal-overlay"), modalTitle: document.getElementById("modal-title"),
                modalText: document.getElementById("modal-text"), modalConfirm: document.getElementById("modal-confirm"),
                modalCancel: document.getElementById("modal-cancel"),
                newDomainName: document.getElementById("newDomainName"), newDomainTasks: document.getElementById("newDomainTasks"),
                newDomainRisks: document.getElementById("newDomainRisks"), newDomainCosts: document.getElementById("newDomainCosts"),
                newDomainKpi: document.getElementById("newDomainKpi"), newDomainDeps: document.getElementById("newDomainDeps"),
                newDomainLimits: document.getElementById("newDomainLimits"), newDomainSources: document.getElementById("newDomainSources"),
                newDomainAllowUnknown: document.getElementById("newDomainAllowUnknown"), newDomainListUnknowns: document.getElementById("newDomainListUnknowns"),
                addDomain: document.getElementById("addDomain"), domainChips: document.getElementById("domainChips")
            };

            // --- Fonctions utilitaires ---
            const getLS = (key, def) => { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch { return def; } };
            const setLS = (key, v) => { try { localStorage.setItem(key, JSON.stringify(v)); } catch {} };

            const fillOptions = (sel, options) => {
                sel.innerHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
            };

            const loadValue = (elem, key, def) => {
                const value = getLS(key, def);
                if (elem) {
                    if (elem.type === "checkbox") {
                        elem.checked = value;
                    } else {
                        elem.value = value;
                    }
                }
            };

            // --- Fonctions de rendu et logique métier ---

            const createOptionManager = (type, defaultData, selectEl, inputEl, chipsEl, addBtnEl) => {
                let options = getLS(`dsi_custom_${type}`, []);
                const allOptions = () => [...defaultData, ...options.map(o => ({ value: o, label: o }))];

                const refresh = () => {
                    fillOptions(selectEl, allOptions());
                    chipsEl.innerHTML = options.map(o =>
                        `<span class="chip">${o} <button title="Supprimer" data-option="${o}" class="text-gray-400 hover:text-red-600 transition-colors">✕</button></span>`
                    ).join('');

                    chipsEl.querySelectorAll("button[data-option]").forEach(btn => {
                        btn.addEventListener("click", () => {
                            const optionToRemove = btn.getAttribute("data-option");
                            options = options.filter(o => o !== optionToRemove);
                            setLS(`dsi_custom_${type}`, options);
                            refresh();
                            updatePreview();
                        });
                    });
                };

                const add = () => {
                    const newOptionText = inputEl.value.trim();
                    if (newOptionText && !allOptions().some(o => o.value === newOptionText)) {
                        options.push(newOptionText);
                        setLS(`dsi_custom_${type}`, options);
                        inputEl.value = "";
                        refresh();
                        updatePreview();
                    }
                };

                if (addBtnEl) {
                    addBtnEl.addEventListener("click", add);
                    inputEl.addEventListener("keydown", (e) => {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            add();
                        }
                    });
                }

                return { refresh, add };
            };

            const domainManager = (() => {
                let customDomains = getLS("dsi_custom_domains", {});
                
                const getDomainPresets = () => {
                    const allPresets = { ...DATA.domainPresets };
                    Object.entries(customDomains).forEach(([key, value]) => {
                        allPresets[key] = value;
                    });
                    return allPresets;
                };

                const refresh = () => {
                    const allPresets = getDomainPresets();
                    fillOptions(els.domain, Object.keys(allPresets).map(k => ({ value: k, label: k })));
                    
                    els.domainChips.innerHTML = Object.keys(customDomains).map(d =>
                        `<span class="chip">${d} <button title="Supprimer le domaine" data-domain="${d}" class="text-gray-400 hover:text-red-600 transition-colors">✕</button></span>`
                    ).join('');

                    els.domainChips.querySelectorAll("button[data-domain]").forEach(btn => {
                        btn.addEventListener("click", () => {
                            const domainToRemove = btn.getAttribute("data-domain");
                            delete customDomains[domainToRemove];
                            setLS("dsi_custom_domains", customDomains);
                            refresh();
                        });
                    });
                };

                const add = () => {
                    const name = els.newDomainName.value.trim();
                    if (!name) return;

                    const newDomain = {
                        tasks: els.newDomainTasks.value.split('\n').map(t => t.trim()).filter(t => t),
                        toggles: {
                            risks: els.newDomainRisks.checked, costs: els.newDomainCosts.checked,
                            kpi: els.newDomainKpi.checked, deps: els.newDomainDeps.checked,
                            limits: els.newDomainLimits.checked, sources: els.newDomainSources.checked,
                            allowUnknown: els.newDomainAllowUnknown.checked, listUnknowns: els.newDomainListUnknowns.checked
                        }
                    };

                    customDomains[name] = newDomain;
                    setLS("dsi_custom_domains", customDomains);
                    
                    // Reset fields
                    els.newDomainName.value = "";
                    els.newDomainTasks.value = "";
                    const toggles = [els.newDomainRisks, els.newDomainCosts, els.newDomainKpi, els.newDomainDeps, els.newDomainLimits, els.newDomainSources, els.newDomainAllowUnknown, els.newDomainListUnknowns];
                    toggles.forEach(t => t.checked = false);

                    refresh();
                };

                return { refresh, add, getDomainPresets };
            })();
            
            const roleManager = createOptionManager('role', DATA.defaultRoles.map(r => ({ value: r, label: r })), els.role, els.newRole, els.rolesChips, els.addRole);
            const formatManager = createOptionManager('format', DATA.outputFormats, els.format, document.querySelector('input[data-type="format"]'), document.getElementById('formatChips'), document.querySelector('button[data-add="format"]'));
            const detailManager = createOptionManager('detail', DATA.detailLevels, els.detail, document.querySelector('input[data-type="detail"]'), document.getElementById('detailChips'), document.querySelector('button[data-add="detail"]'));
            const toneManager = createOptionManager('tone', DATA.tones, els.tone, document.querySelector('input[data-type="tone"]'), document.getElementById('toneChips'), document.querySelector('button[data-add="tone"]'));
            const langManager = createOptionManager('lang', DATA.languages, els.lang, document.querySelector('input[data-type="lang"]'), document.getElementById('langChips'), document.querySelector('button[data-add="lang"]'));

            const renderQuickTasks = () => {
                const presets = domainManager.getDomainPresets();
                const tasks = presets[els.domain.value]?.tasks || [];
                els.quickTasks.innerHTML = tasks.map(qt =>
                    `<button class="text-xs px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 hover:bg-indigo-100 transition-colors">${qt}</button>`
                ).join('');
                els.quickTasks.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener("click", () => {
                        els.task.value = btn.textContent;
                        setLS("dsi_task", els.task.value);
                        updatePreview();
                    });
                });
            };

            const renderTeamAdds = () => {
                els.teamSection.style.display = els.teamMode.checked ? "block" : "none";
                const profile = DATA.teamProfiles.find(p => p.value === els.team.value);
                els.teamAdds.innerHTML = profile?.adds?.map(a => `<li>${a}</li>`).join('') || '';
            };

            const assemblePrompt = () => {
                const promptParts = [];

                promptParts.push(`Tu es ${els.role.value}. Ta mission est de réaliser la tâche décrite en respectant strictement le format et les critères ci‑dessous.`);

                const instructions = [`Sortie attendue: ${els.format.options[els.format.selectedIndex]?.text}`];
                instructions.push(`Rédige en ${els.lang.options[els.lang.selectedIndex]?.text}.`);
                instructions.push(`Ton: ${els.tone.options[els.tone.selectedIndex]?.text}.`);
                instructions.push(`Niveau de détail: ${els.detail.options[els.detail.selectedIndex]?.text}.`);

                const toggleInstructions = {
                    risks: "Inclure une section Risques.", costs: "Inclure estimation des Coûts/TCO si pertinent.",
                    kpi: "Inclure des KPI/mesures de succès.", deps: "Mentionner les dépendances et prérequis.",
                    limits: "Indiquer les hypothèses et limites.", sources: "Fournir des sources ou références quand pertinent.",
                    allowUnknown: "Si une information manque, répondre 'Je ne sais pas' plutôt que d'inventer.",
                    listUnknowns: "Lister explicitement les inconnues et les questions à poser."
                };
                Object.entries(toggleInstructions).forEach(([key, value]) => {
                    if (els[key]?.checked) instructions.push(value);
                });

                if (els.teamMode.checked) {
                    const profile = DATA.teamProfiles.find(p => p.value === els.team.value);
                    if (profile) instructions.push(...profile.adds);
                }

                const context = `Entreprise: ${els.company.value.trim()}\nSecteur: ${els.sector.value.trim()}\nAudience: ${els.audience.value.trim()}${els.teamMode.checked ? ` (adapter au public: ${els.team.options[els.team.selectedIndex]?.text})` : ""}\nObjectifs: ${els.goals.value.trim()}\nContraintes: ${els.constraints.value.trim()}\nÉchéance: ${els.deadline.value.trim()}`;
                
                promptParts.push(`\n<contexte>\n${context}\n</contexte>`);
                promptParts.push(`\n<instructions>\n${instructions.join('\n')}\n</instructions>`);

                if (els.examples.value.trim()) {
                    promptParts.push(`\n<exemples>\n\n${els.examples.value.trim()}\n</exemples>`);
                }
                
                promptParts.push(`\n<criteres_acceptation>\n${els.acceptance.value}\n</criteres_acceptation>`);
                promptParts.push(`\n\`\`\`tache\n${els.task.value}\n\`\`\``);

                return promptParts.join('\n\n');
            };

            const updatePreview = () => {
                els.preview.textContent = assemblePrompt();
            };

            // --- Fonctions de personnalisation de l'apparence ---
            const applyVisualSettings = () => {
                const bgColor = getLS("dsi_bg_color", "#f9fafb");
                const bgImage = getLS("dsi_bg_image", "");
                const titleColor = getLS("dsi_title_color", "#1f2937");
                const logo = getLS("dsi_logo", "");

                document.body.style.backgroundColor = bgColor;
                document.body.style.backgroundImage = bgImage ? `url(${bgImage})` : 'none';
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundRepeat = 'no-repeat';
                els.mainTitle.style.color = titleColor;

                if (logo) {
                    els.logoPreview.src = logo;
                    els.logoContainer.classList.remove("hidden");
                } else {
                    els.logoPreview.src = "";
                    els.logoContainer.classList.add("hidden");
                }
                els.removeLogo.classList.toggle('hidden', !logo);
            };

            // --- Gestion des pop-ups de validation ---
            const showModal = (title, text, onConfirm) => {
                els.modalTitle.textContent = title;
                els.modalText.textContent = text;
                els.modalOverlay.classList.remove("hidden");
                els.modalConfirm.onclick = () => {
                    els.modalOverlay.classList.add("hidden");
                    onConfirm();
                };
                els.modalCancel.onclick = () => {
                    els.modalOverlay.classList.add("hidden");
                };
            };


            // --- Initialisation et événements ---
            const init = () => {
                // Remplir et gérer les options
                domainManager.refresh();
                roleManager.refresh();
                formatManager.refresh();
                detailManager.refresh();
                toneManager.refresh();
                langManager.refresh();
                fillOptions(els.team, DATA.teamProfiles.map(p => ({ value: p.value, label: p.label })));

                // Charger les valeurs persistantes
                const persistenceMap = {
                    domain: "dsi_domain", format: "dsi_format", detail: "dsi_detail", lang: "dsi_lang", tone: "dsi_tone",
                    role: "dsi_role", task: "dsi_task", company: "dsi_company", sector: "dsi_sector", audience: "dsi_audience",
                    goals: "dsi_goals", constraints: "dsi_constraints", deadline: "dsi_deadline", teamMode: "dsi_teamMode",
                    team: "dsi_team", risks: "dsi_risks", costs: "dsi_costs", kpi: "dsi_kpi", deps: "dsi_deps",
                    limits: "dsi_limits", sources: "dsi_sources", allowUnknown: "dsi_allowUnknown", listUnknowns: "dsi_listUnknowns",
                    examples: "dsi_examples", acceptance: "dsi_acceptance",
                };
                Object.entries(persistenceMap).forEach(([elKey, lsKey]) => {
                    loadValue(els[elKey], lsKey, els[elKey]?.value);
                });
                applyVisualSettings(); // Appliquer les paramètres visuels au chargement

                // Gérer les événements de mise à jour et de persistance
                Object.values(els).forEach(elem => {
                    if (elem && (elem.tagName === 'INPUT' || elem.tagName === 'SELECT' || elem.tagName === 'TEXTAREA') && !elem.hasAttribute('data-type')) {
                        elem.addEventListener('input', () => {
                            setLS(persistenceMap[Object.keys(els).find(key => els[key] === elem)], elem.type === 'checkbox' ? elem.checked : elem.value);
                            updatePreview();
                        });
                        elem.addEventListener('change', () => { // pour les select et checkbox
                            setLS(persistenceMap[Object.keys(els).find(key => els[key] === elem)], elem.type === 'checkbox' ? elem.checked : elem.value);
                            updatePreview();
                        });
                    }
                });
                els.domain.addEventListener("change", () => {
                    const preset = domainManager.getDomainPresets()[els.domain.value];
                    if (!preset) return;
                    showModal(
                        "Appliquer le domaine",
                        "Cette action va écraser les paramètres de tâche et de critères. Continuer ?",
                        () => {
                            if (preset.tasks?.[0]) {
                                els.task.value = preset.tasks[0];
                                setLS("dsi_task", els.task.value);
                            }
                            Object.entries(preset.toggles || {}).forEach(([key, checked]) => {
                                els[key].checked = checked;
                                setLS(`dsi_${key}`, checked);
                            });
                            renderQuickTasks();
                            updatePreview();
                        }
                    );
                });
                els.teamMode.addEventListener("change", renderTeamAdds);
                els.team.addEventListener("change", renderTeamAdds);
                
                // Événements des boutons "Paramètres"
                els.settingsBtn.addEventListener('click', () => {
                    els.mainContent.classList.add('hidden');
                    els.settingsPanel.classList.remove('hidden');
                });
                els.closeSettingsBtn.addEventListener('click', () => {
                    els.mainContent.classList.remove('hidden');
                    els.settingsPanel.classList.add('hidden');
                });

                // Gérer les paramètres visuels
                els.bgColor.addEventListener('input', (e) => { setLS("dsi_bg_color", e.target.value); applyVisualSettings(); });
                els.resetBgColor.addEventListener('click', () => { setLS("dsi_bg_color", "#f9fafb"); els.bgColor.value = "#f9fafb"; applyVisualSettings(); });
                els.titleColor.addEventListener('input', (e) => { setLS("dsi_title_color", e.target.value); applyVisualSettings(); });
                els.resetTitleColor.addEventListener('click', () => { setLS("dsi_title_color", "#1f2937"); els.titleColor.value = "#1f2937"; applyVisualSettings(); });

                els.bgImageFile.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            setLS("dsi_bg_image", e.target.result);
                            els.removeBgImage.classList.remove('hidden');
                            applyVisualSettings();
                        };
                        reader.readAsDataURL(file);
                    }
                });
                els.removeBgImage.addEventListener('click', () => {
                    setLS("dsi_bg_image", "");
                    els.bgImageFile.value = '';
                    els.removeBgImage.classList.add('hidden');
                    applyVisualSettings();
                });

                els.logoFile.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            setLS("dsi_logo", e.target.result);
                            applyVisualSettings();
                        };
                        reader.readAsDataURL(file);
                    }
                });
                els.removeLogo.addEventListener('click', () => {
                    showModal(
                        "Supprimer le logo",
                        "Êtes-vous sûr de vouloir supprimer le logo ?",
                        () => {
                            setLS("dsi_logo", "");
                            els.logoFile.value = '';
                            applyVisualSettings();
                        }
                    );
                });

                // Gérer les actions sur les domaines personnalisés
                els.addDomain.addEventListener("click", domainManager.add);

                // Boutons d'action
                els.copyBtn.addEventListener("click", async () => {
                    showModal(
                        "Copier le prompt",
                        "Ceci va copier le prompt généré dans votre presse-papiers.",
                        async () => {
                            try {
                                await navigator.clipboard.writeText(els.preview.textContent);
                                els.copiedBadge.classList.remove("hidden");
                                els.clearBtn.classList.remove("hidden");
                                setTimeout(() => els.copiedBadge.classList.add("hidden"), 2000);
                            } catch {
                                alert("Impossible de copier. Sélectionnez le texte et copiez manuellement.");
                            }
                        }
                    );
                });

                els.clearBtn.addEventListener("click", () => {
                    showModal(
                        "Effacer les entrées",
                        "Ceci va effacer toutes les entrées, y compris le rôle, la tâche, le contexte et les exemples.",
                        () => {
                            const textInputs = [els.task, els.company, els.sector, els.audience, els.goals, els.constraints, els.deadline, els.examples, els.acceptance];
                            textInputs.forEach(input => {
                                input.value = '';
                                setLS(`dsi_${input.id}`, '');
                            });
                            const checkboxes = [els.risks, els.costs, els.kpi, els.deps, els.limits, els.sources, els.allowUnknown, els.listUnknowns];
                            checkboxes.forEach(cb => {
                                cb.checked = false;
                                setLS(`dsi_${cb.id}`, false);
                            });
                            // Réinitialiser les menus à la première option
                            const selects = [els.domain, els.format, els.detail, els.lang, els.tone, els.role, els.team];
                            selects.forEach(select => {
                                select.selectedIndex = 0;
                                setLS(`dsi_${select.id}`, select.value);
                            });
                            els.clearBtn.classList.add("hidden");
                            updatePreview();
                        }
                    );
                });

                els.exportBtn.addEventListener("click", () => {
                    showModal(
                        "Exporter la configuration",
                        "Ceci va télécharger votre configuration actuelle. Vous pourrez l'importer ultérieurement sur un autre navigateur.",
                        () => {
                            const config = Object.fromEntries(
                                Object.entries(persistenceMap).map(([elKey, lsKey]) => [elKey, getLS(lsKey, els[elKey]?.value)])
                            );
                            config.roles = getLS("dsi_custom_role", DATA.defaultRoles);
                            config.custom_formats = getLS("dsi_custom_format", []);
                            config.custom_details = getLS("dsi_custom_detail", []);
                            config.custom_tones = getLS("dsi_custom_tone", []);
                            config.custom_langs = getLS("dsi_custom_lang", []);
                            config.custom_domains = getLS("dsi_custom_domains", {});
                            
                            // Inclure les paramètres visuels
                            config.visualSettings = {
                                bgColor: getLS("dsi_bg_color", "#f9fafb"),
                                bgImage: getLS("dsi_bg_image", ""),
                                titleColor: getLS("dsi_title_color", "#1f2937"),
                                logo: getLS("dsi_logo", "")
                            };

                            const blob = new Blob([JSON.stringify(config, null, 2)], { type: "application/json" });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = "prompt_builder_config.json";
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }
                    );
                });

                els.importFile.addEventListener("change", async (e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    showModal(
                        "Importer une configuration",
                        "Ceci va écraser votre configuration actuelle. Continuer ?",
                        async () => {
                            try {
                                const text = await file.text();
                                const config = JSON.parse(text);
                                Object.entries(config).forEach(([key, value]) => {
                                    const elem = els[key];
                                    if (elem) {
                                        if (elem.type === "checkbox") {
                                            elem.checked = value;
                                        } else {
                                            elem.value = value;
                                        }
                                        setLS(persistenceMap[key], value);
                                    }
                                });
                                if (config.roles) { setLS("dsi_custom_role", config.roles); roleManager.refresh(); }
                                if (config.custom_formats) { setLS("dsi_custom_format", config.custom_formats); formatManager.refresh(); }
                                if (config.custom_details) { setLS("dsi_custom_detail", config.custom_details); detailManager.refresh(); }
                                if (config.custom_tones) { setLS("dsi_custom_tone", config.custom_tones); toneManager.refresh(); }
                                if (config.custom_langs) { setLS("dsi_custom_lang", config.custom_langs); langManager.refresh(); }
                                if (config.custom_domains) { setLS("dsi_custom_domains", config.custom_domains); domainManager.refresh(); }
                                
                                // Import des paramètres visuels
                                if (config.visualSettings) {
                                    setLS("dsi_bg_color", config.visualSettings.bgColor);
                                    setLS("dsi_bg_image", config.visualSettings.bgImage);
                                    setLS("dsi_title_color", config.visualSettings.titleColor);
                                    setLS("dsi_logo", config.visualSettings.logo);
                                    applyVisualSettings();
                                }

                                renderQuickTasks();
                                renderTeamAdds();
                                updatePreview();
                                alert("Configuration importée avec succès !");
                            } catch (error) {
                                alert(`Erreur d'import : ${error.message}`);
                            }
                        }
                    );
                });

                // Rendre les éléments initiaux
                renderQuickTasks();
                renderTeamAdds();
                updatePreview();
            };

            init();
        });
    </script>
</body>
</html>

